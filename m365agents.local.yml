# yaml-language-server: $schema=https://aka.ms/m365-agents-toolkits/v1.11/yaml.schema.json
# Local development configuration for Microsoft Agents Starter Kit
version: v1.11

provision:
  # Creates a Teams app
  - uses: teamsApp/create
    with:
      name: ${{APP_DISPLAY_NAME}}${{APP_NAME_SUFFIX}}
    writeToEnvironmentFile:
      teamsAppId: TEAMS_APP_ID

  # Create or reuse an existing Microsoft Entra application for bot
  - uses: aadApp/create
    with:
      name: ${{APP_DISPLAY_NAME}}${{APP_NAME_SUFFIX}}
      generateClientSecret: true
      generateServicePrincipal: true
      signInAudience: AzureADMyOrg
    writeToEnvironmentFile:
      clientId: BOT_ID
      clientSecret: SECRET_BOT_PASSWORD
      objectId: BOT_OBJECT_ID
      tenantId: BOT_TENANT_ID
      authority: BOT_AUTHORITY
      authorityHost: BOT_AUTHORITY_HOST

  # Configure app registration permissions (expose API, pre-authorize Teams clients)
  - uses: aadApp/update
    with:
      manifestPath: ./infra/entra/entra.bot.manifest.json
      outputFilePath: ./infra/entra/build/entra.bot.manifest.${{TEAMSFX_ENV}}.json

  # Create or update the bot registration on dev.botframework.com
  - uses: botFramework/create
    with:
      botId: ${{BOT_ID}}
      name: ${{APP_DISPLAY_NAME}}${{APP_NAME_SUFFIX}}
      messagingEndpoint: ${{BOT_ENDPOINT}}/api/messages
      description: "Multi-agent orchestrator starter kit"
      iconUrl: https://raw.githubusercontent.com/rodrigodemos/microsoft-agents-starterkit/refs/heads/main/appPackage/agent-framework-96.png
      channels:
        - name: msteams

  # Build app package with latest env value
  - uses: teamsApp/zipAppPackage
    with:
      manifestPath: ./appPackage/manifest.json
      outputZipPath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip
      outputFolder: ./appPackage/build

  # Validate app package
  - uses: teamsApp/validateAppPackage
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip

  # Apply the app manifest
  - uses: teamsApp/update
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip

  # Extend to M365 Copilot
  - uses: teamsApp/extendToM365
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip
    writeToEnvironmentFile:
      titleId: M365_TITLE_ID
      appId: M365_APP_ID

deploy:
  # Generate runtime environment variables
  - uses: file/createOrUpdateEnvironmentFile
    with:
      target: ./.env
      envs:
        PORT: 3978
        # Azure OpenAI
        AZURE_OPENAI_ENDPOINT: ${{AZURE_OPENAI_ENDPOINT}}
        AZURE_OPENAI_DEPLOYMENT: ${{AZURE_OPENAI_DEPLOYMENT}}
        AZURE_OPENAI_API_VERSION: ${{AZURE_OPENAI_API_VERSION}}
        # M365 Auth
        CLIENT_ID: ${{BOT_ID}}
        TENANT_ID: ${{TEAMS_APP_TENANT_ID}}
        # SSO / OBO auth handler
        AUTH_HANDLER_NAME: AGENTIC
        CONNECTIONS__SERVICE_CONNECTION__SETTINGS__CLIENTID: ${{BOT_ID}}
        CONNECTIONS__SERVICE_CONNECTION__SETTINGS__CLIENTSECRET: ${{SECRET_BOT_PASSWORD}}
        CONNECTIONS__SERVICE_CONNECTION__SETTINGS__TENANTID: ${{TEAMS_APP_TENANT_ID}}
        CONNECTIONS__SERVICE_CONNECTION__SETTINGS__SCOPES: ""
        AGENTAPPLICATION__USERAUTHORIZATION__HANDLERS__AGENTIC__SETTINGS__TYPE: AgenticUserAuthorization
        AGENTAPPLICATION__USERAUTHORIZATION__HANDLERS__AGENTIC__SETTINGS__SCOPES: "https://graph.microsoft.com/.default"
        AGENTAPPLICATION__USERAUTHORIZATION__HANDLERS__AGENTIC__SETTINGS__ALTERNATEBLUEPRINTCONNECTIONNAME: "https://graph.microsoft.com/.default"
        CONNECTIONSMAP_0_SERVICEURL: "*"
        CONNECTIONSMAP_0_CONNECTION: SERVICE_CONNECTION
        # Observability
        ENABLE_OBSERVABILITY: "true"
        ENABLE_A365_OBSERVABILITY_EXPORTER: "false"
        ENABLE_OTEL: "true"
        ENABLE_SENSITIVE_DATA: "true"
        OBSERVABILITY_SERVICE_NAME: agents-starterkit
        OBSERVABILITY_SERVICE_NAMESPACE: agents-starterkit
        LOG_LEVEL: INFO
        PYTHON_ENVIRONMENT: development
