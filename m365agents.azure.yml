# yaml-language-server: $schema=https://aka.ms/m365-agents-toolkits/v1.11/yaml.schema.json
# Azure production configuration for Microsoft Agents Starter Kit
# Used AFTER 'azd up' to publish the Teams app manifest.
# App registration and Azure Bot Service are created by azd up.
version: v1.11

provision:
  # Creates a Teams app
  - uses: teamsApp/create
    with:
      name: ${{APP_DISPLAY_NAME}}${{APP_NAME_SUFFIX}}
    writeToEnvironmentFile:
      teamsAppId: TEAMS_APP_ID

  # Configure app registration permissions (expose API, pre-authorize Teams clients)
  # The app registration itself is created by azd up; this step adds SSO permissions.
  - uses: aadApp/update
    with:
      manifestPath: ./infra/entra/entra.bot.manifest.json
      outputFilePath: ./infra/entra/build/entra.bot.manifest.${{TEAMSFX_ENV}}.json

  # Build app package with latest env values
  - uses: teamsApp/zipAppPackage
    with:
      manifestPath: ./appPackage/manifest.json
      outputZipPath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip
      outputFolder: ./appPackage/build

  # Validate app package
  - uses: teamsApp/validateAppPackage
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip

  # Apply the app manifest (publish to org)
  - uses: teamsApp/update
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip

  # Publish to organization app catalog
  - uses: teamsApp/publishAppPackage
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip
    writeToEnvironmentFile:
      publishedAppId: TEAMS_APP_PUBLISHED_APP_ID

  # Extend to M365 Copilot
  - uses: teamsApp/extendToM365
    with:
      appPackagePath: ./appPackage/build/appPackage.${{TEAMSFX_ENV}}.zip
    writeToEnvironmentFile:
      titleId: M365_TITLE_ID
      appId: M365_APP_ID
